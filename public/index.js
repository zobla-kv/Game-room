const chat=document.getElementById("chat"),message=document.getElementById("message"),msgInput=document.getElementById("messageInput"),sendMsg=document.getElementById("messageSend"),msgWrapper=document.getElementById("messageWrapper"),usersOnline=document.getElementById("usersOnline"),userslistWrapper=document.getElementById("usersOnlineListWrapper"),leftNameBox=document.getElementById("player1"),rightNameBox=document.getElementById("player2"),leftPlayerChoice=document.getElementById("choice1Img"),rightPlayerChoice=document.getElementById("choice2Img"),scoreBoxes=document.getElementsByClassName("scoreBox"),leftScore=document.getElementById("player1Score"),rightScore=document.getElementById("player2Score"),startGameButton=document.getElementById("startGameButton"),leaveGame=document.getElementById("leaveGame"),signWrapper=document.getElementById("signWrapper"),signBoxes=document.getElementsByClassName("sign"),lockEffectLeft=document.getElementById("leftPlayerChooseEffect"),lockEffectRight=document.getElementById("rightPlayerChooseEffect"),walls=document.getElementsByClassName("walls"),timer=document.getElementById("timer"),winnerInfo=document.getElementById("winnerInfo"),info=document.getElementById("info"),wallSound=new Audio("./assets/sound/wall-lifting.wav"),startGameSound=new Audio("./assets/sound/game-start.mp3"),lockSound=new Audio("./assets/sound/lock.wav"),gameOverSound=new Audio("./assets/sound/game-over.mp3"),socket=io(3000);let user="";for(;""===user||null===user||user.length>8;)user=prompt("Enter your name(max 8 characters)");const signs=[{name:"rock",src:"./assets/img/rock-lg.PNG"},{name:"paper",src:"./assets/img/paper-lg.PNG"},{name:"scissors",src:"./assets/img/scissors-lg.PNG"}],leftPlayer={},rightPlayer={};function SetSign(){lockSound.play(),triggerLockEffect(lockEffectLeft);const{name:e,src:n}=signs[this.dataset.index],t=e,s=n;leftPlayerChoice.src=s,disableSignChoose(),socket.emit("self-choose-sign",{user:user,sign:t})}function printUsers(e){userslistWrapper.innerHTML="";for(let n=0;n<e.length;n++){const t=document.createElement("li"),s=document.createElement("span");s.innerHTML=e[n].name,s.innerHTML=s.innerHTML.padEnd(8),t.appendChild(s),userslistWrapper.appendChild(t)}}socket.emit("new-user",user),sendMsg.addEventListener("click",e=>{e.preventDefault();const n=msgInput.value;socket.emit("new-message",{user:user,message:n}),printMessage(`You: ${n}`),msgInput.value=""}),leftNameBox.addEventListener("click",()=>{"JOIN"===leftNameBox.innerHTML&&(socket.emit("self-join-game",user),leftNameBox.innerHTML=user,leaveGame.style.display="block",signWrapper.style.display="flex")}),startGameButton.addEventListener("click",()=>{const e=[];e.push({name:leftNameBox.innerHTML,sign:"",score:0},{name:rightNameBox.innerHTML,sign:"",score:0}),startGameSound.play(),clearScoreBoxes(),showScoreBoxes(),enableEffect(),enableSignChoose(),assignSignBoxesToPlayers(),socket.emit("players-set",e),startGameButton.style.display="none",winnerInfo.innerHTML=""}),leaveGame.addEventListener("click",()=>{socket.emit("self-leave-game",{player:user,type:"left-game"}),hideScoreBoxes(),leftNameBox.innerHTML="JOIN",leaveGame.style.display="none",signWrapper.style.display="none",startGameButton.style.display="none"}),window.onbeforeunload=(()=>{socket.emit("self-leave-game",{player:user,type:"left-site"})}),socket.on("users-connected",e=>{printUsers(e)}),socket.on("print-message",({user:e,message:n})=>{printMessage(`${e}: ${n}`)}),socket.on("player-joined-game",({player:e,playersInGame:n})=>{"waiting.."===rightNameBox.innerHTML?rightNameBox.innerHTML=e:leftNameBox.innerHTML=e,2===n.length&&n.includes(user)&&(startGameButton.style.display="block")}),socket.on("players-in-game",e=>{1===e.length&&(rightNameBox.innerHTML=e[0]),2===e.length&&(leftNameBox.innerHTML=e[0],rightNameBox.innerHTML=e[1])}),socket.on("start-game",e=>{startGameSound.play(),clearScoreBoxes(),showScoreBoxes(),enableEffect(),assignSignBoxesToPlayers(),isUserSpectator(e)||enableSignChoose(),startGameButton.style.display="none",winnerInfo.innerHTML=""}),socket.on("player-chose-sign",({player:e,players:n})=>{lockSound.play();const t=signs.findIndex(n=>n.name===e.sign);isUserSpectator(n)&&leftPlayer.name===e.name?(leftPlayer.choice.src=signs[t].src,triggerLockEffect(lockEffectLeft)):(rightPlayer.choice.src=signs[t].src,triggerLockEffect(lockEffectRight))}),socket.on("start-round",async(e,n,t)=>{showTimer(),await startCountdown(),setTimeout(()=>{hideTimer()},200),await liftWalls(),updateScore(e,t),n?(gameOverSound.play(),await displayWinner({type:"gameWinner",winner:n}),isUserSpectator(t)||(startGameButton.style.display="block")):await displayWinner({type:"roundWinner",winner:e}),await dropWalls(),n||enableSignChoose()}),socket.on("player-left-game",({player:e,playersInGame:n})=>{if(n.includes(e)){if(hideScoreBoxes(),n.includes(user))rightNameBox.innerHTML="waiting..",disableSignChoose();else if(2===n.length){const t=0===n.findIndex(n=>n===e)?1:0;rightNameBox.innerHTML=n[t],leftNameBox.innerHTML="JOIN"}else 1===n.length&&(leftNameBox.innerHTML="JOIN",rightNameBox.innerHTML="waiting..");startGameButton.style.display="none"}}),socket.on("user-disconnected",({usersOnline:e,removedUser:n})=>{userLeftInfo(n),printUsers(e)}),socket.on("adjust-for-mid-game-spec",async(e,n,t,s)=>{s?(updateScore(e,t),n?await displayWinner({type:"gameWinner",winner:n}):await displayWinner({type:"roundWinner",winner:e})):(hideScoreBoxes(),winnerInfo.innerHTML="")}),socket.on("show-signs",e=>{showPlayerSigns(e)});let msgCounter=0;function printMessage(e){const n=document.createElement("div");n.setAttribute("id","message"),n.innerHTML=e,msgWrapper.appendChild(n),++msgCounter>6&&(chat.scrollTop+=40)}function enableSignChoose(){[].forEach.call(signBoxes,(e,n)=>{e.dataset.index=n,e.addEventListener("click",SetSign)})}function disableSignChoose(){[].forEach.call(signBoxes,(e,n)=>{e.removeEventListener("click",SetSign)})}function isUserSpectator(e){let n;for(let t=0;t<e.length&&!(n=e[t].name===user);t++);return!n}function assignSignBoxesToPlayers(){leftPlayer.name=leftNameBox.innerHTML,leftPlayer.choice=leftPlayerChoice,rightPlayer.name=rightNameBox.innerHTML,rightPlayer.choice=rightPlayerChoice}function showPlayerSigns(e){const n=signs.findIndex(n=>n.name===e[0].sign),t=signs.findIndex(n=>n.name===e[1].sign);if(-1!==n&&-1!==t)assignSignToBoth(n,t,e);else{if(!(-1!==n&&-1===t||-1===n&&-1!==t))return;assignSignToOne(n,t,e)}}function assignSignToBoth(e,n,t){leftPlayer.name===t[0].name?leftPlayer.choice.src=signs[e].src:leftPlayer.choice.src=signs[n].src,rightPlayer.name===t[0].name?rightPlayer.choice.src=signs[e].src:rightPlayer.choice.src=signs[n].src}function assignSignToOne(e,n,t){""!==t[0].sign?leftPlayer.name===t[0].name?leftPlayer.choice.src=signs[e].src:rightPlayer.choice.src=signs[e].src:""!==t[1].sign&&(leftPlayer.name===t[1].name?leftPlayer.choice.src=signs[n].src:rightPlayer.choice.src=signs[n].src)}function enableEffect(){lockEffectLeft.style.display="block",lockEffectRight.style.display="block"}function triggerLockEffect(e){e.style.transform="scale(1.2)",e.style.opacity=0,setTimeout(()=>{e.style.transform="scale(1)",setTimeout(()=>{e.style.opacity=1},300)},500)}function liftWalls(){wallSound.play();let e=0;return new Promise(n=>{const t=setInterval(()=>{e-=1;for(let n=0;n<walls.length;n++)walls[n].style.marginTop=e+"px";e<-270&&(clearInterval(t),n())},8)})}function dropWalls(){wallSound.play();let e=-270;return new Promise(n=>{const t=setInterval(()=>{e+=1;for(let n=0;n<walls.length;n++)walls[n].style.marginTop=e+"px";e>0&&(clearInterval(t),n())})},8)}function showScoreBoxes(){for(let e=0;e<scoreBoxes.length;e++)scoreBoxes[e].style.display="block"}function hideScoreBoxes(){for(let e=0;e<scoreBoxes.length;e++)scoreBoxes[e].style.display="none"}function showTimer(){timer.style.display="block"}function hideTimer(){timer.style.display="none"}function startCountdown(){let e=3;return timer.innerHTML=e,new Promise(n=>{let t=setInterval(()=>{e--,timer.innerHTML=e,0===e&&(clearInterval(t),n())},1e3)})}function displayWinner({type:e,winner:n}){if(winnerInfo.style.display="block","roundWinner"===e){winnerInfo.innerHTML=`${n} won this round`.toUpperCase();let e=0;return new Promise(n=>{const t=setInterval(()=>{"block"===winnerInfo.style.display?winnerInfo.style.display="none":winnerInfo.style.display="block",8===++e&&(clearInterval(t),winnerInfo.style.display="none",n())},800)})}return winnerInfo.innerHTML=`${n} won game !!!`.toUpperCase(),new Promise(e=>{setTimeout(()=>{e()},3e3)})}function updateScore(e,n){if(assignScore(n),"nobody"===e)return;let t;for(let s=0;s<n.length;s++)n[s].name===e&&(t=n[s]);leftPlayer.name===e?leftScore.innerHTML=t.score:rightScore.innerHTML=t.score}function assignScore(e){leftPlayer.name===e[0].name?leftScore.innerHTML=e[0].score:rightScore.innerHTML=e[0].score,rightPlayer.name===e[1].name?rightScore.innerHTML=e[1].score:leftPlayer.innerHTML=e[1].score}function clearScoreBoxes(){leftScore.innerHTML=0,rightScore.innerHTML=0}function userLeftInfo(e){const n=document.createElement("div");n.setAttribute("id","infoItem"),n.innerHTML=`${e} left`,info.appendChild(n);let t=0,s=setInterval(()=>{t+=.1,n.style.opacity=t,t>1&&(clearInterval(s),setTimeout(()=>{let e=setInterval(()=>{t-=.1,n.style.opacity=t,t<0&&(clearInterval(e),info.removeChild(n))},50)},2e3))},50)}function stopResponsiveTransition(){const e=document.body.classList;let n=null;window.addEventListener("resize",function(){n?(clearTimeout(n),n=null):e.add("stop-transition"),n=setTimeout(()=>{e.remove("stop-transition"),n=null},100)})}leftScore.innerHTML=0,rightScore.innerHTML=0,stopResponsiveTransition();