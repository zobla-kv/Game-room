const io=require("socket.io")(3e3),users={online:[]},playersInGame=[];let players,gameStartTime,roundWinner,gameWinner,gameRunning=!1;function updateInGameStatus(e,n){if("add"===n)playersInGame.push(e);else{const n=playersInGame.findIndex(n=>n===e);-1!==n&&playersInGame.splice(n,1)}}function whoWonRound(){const e=players[0],n=players[1];return e.sign===n.sign?"nobody":"rock"===e.sign?"paper"===n.sign?n.name:e.name:"paper"===e.sign?"rock"===n.sign?e.name:n.name:"scissors"===e.sign?"rock"===n.sign?n.name:winner=e.name:void 0}function updateScore(e){for(let n=0;n<players.length;n++)players[n].name===e&&(players[n].score++,3===players[n].score&&(gameWinner=players[n].name))}function removeUserFromSite(e,n){const s=users.online.findIndex(n=>n.name===e);let a=users.online.splice(s,1);n.broadcast.emit("user-disconnected",{usersOnline:users.online,removedUser:a[0].name})}io.on("connection",e=>{e.on("new-user",n=>{users.online.push({name:n,inGame:!1,onlineSince:Date.now()}),e.emit("users-connected",users.online),e.broadcast.emit("users-connected",users.online),e.emit("players-in-game",playersInGame),void 0!==players&&(e.emit("start-game",players),e.emit("show-signs",players),users.online[users.online.length-1].onlineSince>gameStartTime&&e.emit("adjust-for-mid-game-spec",roundWinner,gameWinner,players,gameRunning))}),e.on("new-message",n=>{e.broadcast.emit("print-message",n)}),e.on("self-join-game",n=>{updateInGameStatus(n,"add"),e.broadcast.emit("player-joined-game",{player:n,playersInGame:playersInGame})}),e.on("self-leave-game",({player:n,type:s})=>{e.broadcast.emit("player-left-game",{player:n,playersInGame:playersInGame}),gameRunning=!1,setTimeout(()=>{updateInGameStatus(n,"remove"),"left-site"==s&&removeUserFromSite(n,e)},10)}),e.on("self-leave",({user:n,type:s})=>{removeUserFromSite(n,e)}),e.on("players-set",n=>{gameWinner=null,players=n,gameStartTime=Date.now(),gameRunning=!0,e.broadcast.emit("start-game",players)}),e.on("self-choose-sign",({user:n,sign:s})=>{const a=players.findIndex(e=>e.name===n);players[a].sign=s,e.broadcast.emit("player-chose-sign",{player:players[a],players:players}),""!==players[0].sign&&""!==players[1].sign&&(updateScore(roundWinner=whoWonRound()),e.emit("start-round",roundWinner,gameWinner,players),e.broadcast.emit("start-round",roundWinner,gameWinner,players),setTimeout(()=>{for(let e=0;e<players.length;e++)players[e].sign=""},1e3))})}),module.exports=io;